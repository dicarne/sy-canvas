{"version":3,"file":"index.c9b106b5.js","sources":["../../vite/modulepreload-polyfill","../../src/lib/useDraw.ts","../../src/components/SYCanvas.vue","../../src/main.ts"],"sourcesContent":["const p = function polyfill() {\n    const relList = document.createElement('link').relList;\n    if (relList && relList.supports && relList.supports('modulepreload')) {\n        return;\n    }\n    for (const link of document.querySelectorAll('link[rel=\"modulepreload\"]')) {\n        processPreload(link);\n    }\n    new MutationObserver((mutations) => {\n        for (const mutation of mutations) {\n            if (mutation.type !== 'childList') {\n                continue;\n            }\n            for (const node of mutation.addedNodes) {\n                if (node.tagName === 'LINK' && node.rel === 'modulepreload')\n                    processPreload(node);\n            }\n        }\n    }).observe(document, { childList: true, subtree: true });\n    function getFetchOpts(script) {\n        const fetchOpts = {};\n        if (script.integrity)\n            fetchOpts.integrity = script.integrity;\n        if (script.referrerpolicy)\n            fetchOpts.referrerPolicy = script.referrerpolicy;\n        if (script.crossorigin === 'use-credentials')\n            fetchOpts.credentials = 'include';\n        else if (script.crossorigin === 'anonymous')\n            fetchOpts.credentials = 'omit';\n        else\n            fetchOpts.credentials = 'same-origin';\n        return fetchOpts;\n    }\n    function processPreload(link) {\n        if (link.ep)\n            // ep marker = processed\n            return;\n        link.ep = true;\n        // prepopulate the load record\n        const fetchOpts = getFetchOpts(link);\n        fetch(link.href, fetchOpts);\n    }\n};__VITE_IS_MODERN__&&p();","\r\nexport const useDraw = () => {\r\n\r\n}\r\n\r\nexport interface DrawStoke {\r\n    width: number\r\n    color: string\r\n    points: point[]\r\n}\r\n\r\nexport interface point {\r\n    x: number, y: number\r\n}\r\nexport function decode(base64: string) {\r\n    // 对base64转编码\r\n    var decode = atob(base64);\r\n    // 编码转字符串\r\n    var str = decodeURI(decode);\r\n    return str;\r\n}\r\n\r\nexport interface DrawData {\r\n    version: number\r\n    stokes: DrawStoke[]\r\n    config: {\r\n        color: string\r\n        width: number,\r\n        background: string\r\n    }\r\n}","<script lang=\"ts\" setup>\r\n\r\nimport { onMounted, reactive, ref, toRaw } from 'vue';\r\nimport { decode, DrawData, DrawStoke } from \"../lib/useDraw\"\r\nimport { throttle } from 'lodash';\r\nimport { api, util } from \"siyuan_api_cache_lib\"\r\nimport { NColorPicker, NSlider, NButton, NSpace, NModal, NCard, useDialog } from \"naive-ui\"\r\nconst canvas = ref<any>(null)\r\nconst ctx = ref<CanvasRenderingContext2D>()\r\nconst canvas_args = reactive({\r\n    w: 1000,\r\n    h: 1000,\r\n})\r\nconst mouseDown = ref(false)\r\nconst stokes = ref<DrawStoke[]>([])\r\nconst stoke = ref<DrawStoke>({\r\n    width: 2,\r\n    color: \"#000000\",\r\n    points: []\r\n})\r\nconst canvas_config = reactive({\r\n    color: \"#000\",\r\n    width: 3,\r\n    background: \"#fff\"\r\n})\r\nconst redraw = throttle(() => {\r\n    if (!ctx.value) return\r\n    ctx.value.fillStyle = canvas_config.background\r\n    ctx.value.fillRect(0, 0, canvas_args.w, canvas_args.h)\r\n    stokes.value.forEach(s => {\r\n        if (!ctx.value || s.points.length <= 1) return\r\n        ctx.value.beginPath()\r\n        ctx.value.strokeStyle = s.color\r\n        ctx.value.lineJoin = \"round\"\r\n        ctx.value.lineWidth = s.width\r\n        ctx.value.moveTo(s.points[0].x, s.points[0].y)\r\n        for (let i = 1; i < s.points.length; i++) {\r\n            const p = s.points[i];\r\n            ctx.value.lineTo(p.x, p.y)\r\n        }\r\n        ctx.value.stroke()\r\n        ctx.value.closePath()\r\n    });\r\n}, 500)\r\nonMounted(async () => {\r\n    const id = util.currentNodeId()\r\n    if (canvas.value) {\r\n        ctx.value = canvas.value.getContext(\"2d\");\r\n        if (!ctx.value) return\r\n        ctx.value.imageSmoothingEnabled = true\r\n        canvas_args.w = canvas.value.clientWidth\r\n        canvas_args.h = canvas.value.clientHeight\r\n        const data = await api.getBlockAttr(id!, \"custom-data\")\r\n        if (data) {\r\n            const d = JSON.parse(decode(data.value)) as DrawData\r\n            stokes.value = d.stokes\r\n            canvas_config.background = d.config.background\r\n            canvas_config.color = d.config.color\r\n            canvas_config.width = d.config.width\r\n        }\r\n        setTimeout(redraw, 1)\r\n    }\r\n    window.onresize = () => {\r\n        canvas_args.w = canvas.value.clientWidth\r\n        canvas_args.h = canvas.value.clientHeight\r\n        ctx.value = canvas.value.getContext(\"2d\");\r\n        setTimeout(redraw, 1)\r\n    }\r\n})\r\nconst getClientSize = () => {\r\n    if (canvas.value) {\r\n        return {\r\n            w: canvas.value.clientWidth,\r\n            h: canvas.value.clientHeight\r\n        }\r\n    }\r\n    return null\r\n}\r\n\r\nconst getMousePosition = (e: MouseEvent) => {\r\n    const c = getClientSize()!\r\n    return {\r\n        x: Math.trunc(e.clientX / c.w * canvas_args.w),\r\n        y: Math.trunc(e.clientY / c.h * canvas_args.h)\r\n    }\r\n}\r\n\r\nconst OnMouseDown = (arg: MouseEvent) => {\r\n    const p = getMousePosition(arg)\r\n    mouseDown.value = true\r\n    if (!ctx.value) return\r\n    ctx.value.beginPath()\r\n    stoke.value = {\r\n        width: canvas_config.width,\r\n        color: canvas_config.color,\r\n        points: [p]\r\n    }\r\n    ctx.value.moveTo(p.x, p.y)\r\n    ctx.value.strokeStyle = stoke.value.color\r\n    ctx.value.lineJoin = \"round\"\r\n    ctx.value.lineWidth = stoke.value.width\r\n}\r\n\r\nconst _drawNewPoint = (p: { x: number, y: number }) => {\r\n    if (!ctx.value) return\r\n    stoke.value.points.push(p)\r\n    ctx.value.lineTo(p.x, p.y)\r\n    ctx.value.stroke()\r\n}\r\nconst OnMouseMove = (arg: MouseEvent) => {\r\n    if (mouseDown.value) {\r\n        const p = getMousePosition(arg)\r\n        _drawNewPoint(p)\r\n    }\r\n}\r\nconst save = () => {\r\n    api.setBlockAttrs({\r\n        id: util.currentNodeId()!,\r\n        attrs: {\r\n            \"custom-data\": btoa(encodeURI(JSON.stringify({\r\n                version: 1,\r\n                stokes: toRaw(stokes.value),\r\n                config: canvas_config\r\n            })))\r\n        }\r\n    })\r\n}\r\nconst OnMouseUp = (arg: MouseEvent) => {\r\n    if (mouseDown.value) {\r\n        mouseDown.value = false\r\n        if (!ctx.value) return\r\n        const p = getMousePosition(arg)\r\n        ctx.value.lineTo(p.x, p.y)\r\n        ctx.value.stroke()\r\n        ctx.value.closePath()\r\n        stokes.value.push(stoke.value)\r\n        stoke.value = null as any\r\n        save()\r\n    }\r\n}\r\nconst changeColor = (newc: string) => {\r\n    canvas_config.color = newc\r\n}\r\nconst colorSwatches = ref(['#FFFFFF', '#000', '#18A058', '#2080F0', '#F0A020', 'rgba(208, 48, 80, 1)'])\r\n\r\nconst setting = reactive({\r\n    show: false,\r\n    background: \"#fff\",\r\n    changeColor: (newc: string) => {\r\n        setting.background = newc\r\n    },\r\n    ok: () => {\r\n        canvas_config.background = setting.background\r\n        setting.show = false\r\n        save()\r\n        setTimeout(redraw, 1)\r\n    }\r\n})\r\n// 撤销\r\nconst nooooo = () => {\r\n    stokes.value.splice(stokes.value.length - 1, 1)\r\n    redraw()\r\n    save()\r\n}\r\nconst dialog = useDialog()\r\nconst clearAll = () => {\r\n    dialog.warning({\r\n        title: '警告',\r\n        content: '是否清空所有内容？该操作不可撤销！',\r\n        positiveText: '确定',\r\n        negativeText: '不确定',\r\n        onPositiveClick: () => {\r\n            stokes.value = []\r\n            canvas_config.background = \"#fff\"\r\n            redraw()\r\n            save()\r\n            setting.show = false\r\n        },\r\n        onNegativeClick: () => {\r\n            \r\n        }\r\n    })\r\n}\r\n</script>\r\n<template>\r\n    <canvas\r\n        :style=\"{\r\n            width: '100vw',\r\n            height: '100vh'\r\n        }\"\r\n        :width=\"canvas_args.w\"\r\n        :height=\"canvas_args.h\"\r\n        ref=\"canvas\"\r\n        :onmousedown=\"OnMouseDown\"\r\n        :onmousemove=\"OnMouseMove\"\r\n        :onmouseleave=\"OnMouseUp\"\r\n        :onmouseup=\"OnMouseUp\"\r\n    />\r\n    <div\r\n        :style=\"{\r\n            position: 'fixed',\r\n            bottom: '0px',\r\n            width: '100vw',\r\n            backgroundColor: '#fff',\r\n            paddingTop: '10px',\r\n            paddingLeft: '5px'\r\n        }\"\r\n    >\r\n        <n-space>\r\n            <n-button @click=\"setting.show = true\">设置</n-button>\r\n            <n-button @click=\"nooooo()\">撤销</n-button>\r\n            <n-color-picker\r\n                :on-update:value=\"changeColor\"\r\n                :style=\"{\r\n                    width: '40vw',\r\n                    minWidth: '300px',\r\n                    maxWidth: '500px'\r\n                }\"\r\n                :show-alpha=\"false\"\r\n                :swatches=\"colorSwatches\"\r\n            />\r\n            <n-slider\r\n                v-model:value=\"canvas_config.width\"\r\n                :step=\"1\"\r\n                :min=\"1\"\r\n                :max=\"20\"\r\n                :style=\"{\r\n                    width: '40vw',\r\n                    minWidth: '300px',\r\n                    maxWidth: '500px'\r\n                }\"\r\n            />\r\n        </n-space>\r\n    </div>\r\n    <n-modal\r\n        v-model:show=\"setting.show\"\r\n        :style=\"{\r\n            position: 'fixed',\r\n            top: '10px',\r\n        \r\n        }\"\r\n    >\r\n        <n-card :style=\"{ width: '100vw' }\" title=\"设置\" :bordered=\"false\" size=\"huge\">\r\n            背景颜色\r\n            <n-color-picker\r\n                :show-alpha=\"false\"\r\n                :on-update:value=\"setting.changeColor\"\r\n                :default-value=\"canvas_config.background\"\r\n            />\r\n            <n-space>\r\n                <n-button @click=\"clearAll\">清空</n-button>\r\n            </n-space>\r\n            <template #footer>\r\n                <n-space>\r\n                    <n-button @click=\"setting.show = false\">取消</n-button>\r\n                    <n-button @click=\"setting.ok()\">确认</n-button>\r\n                </n-space>\r\n            </template>\r\n        </n-card>\r\n    </n-modal>\r\n</template>","import { createApp } from 'vue'\r\nimport App from './App.vue'\r\n\r\ncreateApp(App).mount('#app')\r\n"],"names":["throttle","util.currentNodeId","App"],"mappings":"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"}